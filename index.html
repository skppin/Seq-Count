<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shared Grid Tracker</title>
  <style>
    :root {
      --gap: 6px;
      --cell-size: 46px;
      --green: #2ecc71;
      --border: #d0d0d0;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 20px;
      color: #222;
    }

    .board {
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 16px;
      background: #fff;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }

    .board h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px 14px;
      margin-bottom: 12px;
    }

    .stats {
      display: flex;
      gap: 14px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid #eee;
      border-radius: 10px;
      background: #fafafa;
    }

    .stat { font-size: 14px; }
    .stat b { font-size: 16px; }

    button.action {
      cursor: pointer;
      border: 1px solid #ccc;
      background: white;
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 700;
    }

    button.action:hover { background: #f5f5f5; }

    .status {
      font-size: 13px;
      color: #555;
    }

    .grid {
      display: grid;
      gap: var(--gap);
      user-select: none;
    }

    .cell {
      width: var(--cell-size);
      height: var(--cell-size);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      font-weight: 700;
      font-size: 13px;
      transition: transform 80ms ease, background 120ms ease, border-color 120ms ease;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }

    .cell:active { transform: scale(0.98); }

    .cell.green {
      background: var(--green);
      border-color: #25b864;
      color: #0b3a1e;
    }

    footer {
      margin-top: 10px;
      font-size: 12px;
      color: #666;
    }

    @media (max-width: 900px) { :root { --cell-size: 38px; } }
    @media (max-width: 650px) { :root { --cell-size: 32px; --gap: 5px; } }
  </style>
</head>
<body>

  <div class="board">
    <h2>Main Grid (15×16)</h2>

    <div class="row">
      <div class="stats" aria-live="polite">
        <div class="stat">Completed: <b id="mainCompletedCount">0</b></div>
        <div class="stat">Remaining: <b id="mainRemainingCount">240</b></div>
        <div class="stat">Total: <b>240</b></div>
      </div>

      <button class="action" id="mainExportTxtBtn" type="button">Export (.txt)</button>
      <button class="action" id="mainExportCsvBtn" type="button">Export (.csv / Excel)</button>
      <span class="status" id="mainSyncStatus">Connecting…</span>
    </div>

    <div id="mainGrid" class="grid" role="grid" aria-label="15 by 16 clickable grid"></div>
  </div>

  <div class="board">
    <h2>Penalty & Referee Sequences (5×10)</h2>

    <div class="row">
      <div class="stats" aria-live="polite">
        <div class="stat">Completed: <b id="prCompletedCount">0</b></div>
        <div class="stat">Remaining: <b id="prRemainingCount">50</b></div>
        <div class="stat">Total: <b>50</b></div>
      </div>

      <button class="action" id="prExportTxtBtn" type="button">Export (.txt)</button>
      <button class="action" id="prExportCsvBtn" type="button">Export (.csv / Excel)</button>
      <span class="status" id="prSyncStatus">Connecting…</span>
    </div>

    <div id="prGrid" class="grid" role="grid" aria-label="5 by 10 clickable grid"></div>
  </div>

  <footer>
    Shared mode: updates sync for everyone using the same page (Firebase Firestore).
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, onSnapshot, runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ✅ PASTE YOUR firebaseConfig HERE
    const firebaseConfig = {
      apiKey: "AIzaSyBQtfudSJNZb3AyQiNTDfZM0E0LwdEBm1M",
    authDomain: "seq-helper-2026.firebaseapp.com",
    projectId: "seq-helper-2026",
    storageBucket: "seq-helper-2026.firebasestorage.app",
    messagingSenderId: "724035616020",
    appId: "1:724035616020:web:bb31393c2bec91ca955601",
    measurementId: "G-YDCLDEBSYF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /**
     * Creates a shared grid that syncs to a Firestore document:
     * collection: trackers
     * docId: provided
     * field: completed (number array)
     */
    function createSharedGrid(opts) {
      const {
        docId,
        rows,
        cols,
        total,
        gridEl,
        completedCountEl,
        remainingCountEl,
        exportTxtBtn,
        exportCsvBtn,
        syncStatusEl,
        exportBaseName
      } = opts;

      gridEl.style.gridTemplateColumns = `repeat(${cols}, var(--cell-size))`;

      const docRef = doc(db, "trackers", docId);

      let completedSet = new Set();
      let busy = false;

      function updateCounts() {
        completedCountEl.textContent = String(completedSet.size);
        remainingCountEl.textContent = String(total - completedSet.size);
      }

      function renderGridSkeletonIfNeeded() {
        if (gridEl.childElementCount === total) return;

        gridEl.innerHTML = "";
        const frag = document.createDocumentFragment();

        for (let i = 1; i <= total; i++) {
          const cell = document.createElement("button");
          cell.type = "button";
          cell.className = "cell";
          cell.textContent = i;
          cell.setAttribute("role", "gridcell");
          cell.dataset.index = String(i);

          cell.addEventListener("click", async () => {
            if (busy) return;
            busy = true;
            syncStatusEl.textContent = "Saving…";

            const idx = Number(cell.dataset.index);

            try {
              await runTransaction(db, async (tx) => {
                const snap = await tx.get(docRef);
                const data = snap.exists() ? snap.data() : {};
                const arr = Array.isArray(data.completed) ? data.completed : [];
                const set = new Set(
                  arr.filter(n => Number.isInteger(n) && n >= 1 && n <= total)
                );

                if (set.has(idx)) set.delete(idx);
                else set.add(idx);

                tx.set(docRef, { completed: Array.from(set).sort((a,b)=>a-b), updatedAt: serverTimestamp() }, { merge: true });
              });
            } catch (e) {
              console.error(e);
              alert("Failed to save. Check Firebase config / Firestore rules.");
            } finally {
              busy = false;
            }
          });

          frag.appendChild(cell);
        }

        gridEl.appendChild(frag);
      }

      function applyStateToUI() {
        for (let i = 1; i <= total; i++) {
          const cell = gridEl.children[i - 1];
          const done = completedSet.has(i);
          cell.classList.toggle("green", done);
          cell.setAttribute("aria-pressed", done ? "true" : "false");
        }
        updateCounts();
      }

      function getList() {
        return Array.from(completedSet).sort((a, b) => a - b);
      }

      exportTxtBtn.addEventListener("click", () => {
        const list = getList();
        const content = list.length ? list.join("\n") + "\n" : "";
        downloadBlob(new Blob([content], { type: "text/plain;charset=utf-8" }), `${exportBaseName}.txt`);
      });

      exportCsvBtn.addEventListener("click", () => {
        const list = getList();
        const lines = ["BlockNumber", ...list.map(String)];
        const csv = lines.join("\r\n") + "\r\n";
        downloadBlob(new Blob([csv], { type: "text/csv;charset=utf-8" }), `${exportBaseName}.csv`);
      });

      // Initial render
      renderGridSkeletonIfNeeded();
      applyStateToUI();

      // Live sync
      syncStatusEl.textContent = "Connecting…";
      onSnapshot(docRef, (snap) => {
        syncStatusEl.textContent = "Synced ✓";
        const data = snap.exists() ? snap.data() : {};
        const arr = Array.isArray(data.completed) ? data.completed : [];
        completedSet = new Set(arr.filter(n => Number.isInteger(n) && n >= 1 && n <= total));
        renderGridSkeletonIfNeeded();
        applyStateToUI();
      }, (err) => {
        console.error(err);
        syncStatusEl.textContent = "Sync error";
        alert("Sync error. Check Firebase config / Firestore rules.");
      });
    }

    // Main 15x16 grid (1..240)
    createSharedGrid({
      docId: "main_15x16",
      rows: 15,
      cols: 16,
      total: 240,
      gridEl: document.getElementById("mainGrid"),
      completedCountEl: document.getElementById("mainCompletedCount"),
      remainingCountEl: document.getElementById("mainRemainingCount"),
      exportTxtBtn: document.getElementById("mainExportTxtBtn"),
      exportCsvBtn: document.getElementById("mainExportCsvBtn"),
      syncStatusEl: document.getElementById("mainSyncStatus"),
      exportBaseName: "main_grid"
    });

    // Penalty & Referee sequences 5x10 grid (1..50)
    createSharedGrid({
      docId: "penalty_referee_5x10",
      rows: 5,
      cols: 10,
      total: 50,
      gridEl: document.getElementById("prGrid"),
      completedCountEl: document.getElementById("prCompletedCount"),
      remainingCountEl: document.getElementById("prRemainingCount"),
      exportTxtBtn: document.getElementById("prExportTxtBtn"),
      exportCsvBtn: document.getElementById("prExportCsvBtn"),
      syncStatusEl: document.getElementById("prSyncStatus"),
      exportBaseName: "penalty_referee_grid"
    });
  </script>
</body>
</html>
